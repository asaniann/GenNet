# Prometheus Alert Rules for GenNet Services

groups:
- name: gennet_services
  interval: 30s
  rules:
  # High error rate
  - alert: HighErrorRate
    expr: |
      sum(rate(http_requests_total{status=~"5.."}[5m])) by (service) 
      / 
      sum(rate(http_requests_total[5m])) by (service) 
      > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected in {{ $labels.service }}"
      description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.service }}"
  
  # High latency
  - alert: HighLatency
    expr: |
      histogram_quantile(0.95, 
        sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
      ) > 1.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High latency detected in {{ $labels.service }}"
      description: "p95 latency is {{ $value }}s for {{ $labels.service }}"
  
  # Service down
  - alert: ServiceDown
    expr: up{job=~"gennet-.*"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.job }} is down"
      description: "Service {{ $labels.job }} has been down for more than 1 minute"
  
  # High memory usage
  - alert: HighMemoryUsage
    expr: |
      (container_memory_usage_bytes{job=~"gennet-.*"} 
      / 
      container_spec_memory_limit_bytes{job=~"gennet-.*"}) > 0.9
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage in {{ $labels.job }}"
      description: "Memory usage is {{ $value | humanizePercentage }} for {{ $labels.job }}"
  
  # High CPU usage
  - alert: HighCPUUsage
    expr: |
      rate(container_cpu_usage_seconds_total{job=~"gennet-.*"}[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage in {{ $labels.job }}"
      description: "CPU usage is {{ $value | humanizePercentage }} for {{ $labels.job }}"

- name: gennet_infrastructure
  interval: 30s
  rules:
  # Database connection issues
  - alert: DatabaseConnectionFailure
    expr: |
      increase(database_connection_errors_total[5m]) > 10
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Database connection failures detected"
      description: "{{ $value }} database connection errors in the last 5 minutes"
  
  # Redis connection issues
  - alert: RedisConnectionFailure
    expr: |
      redis_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis is down"
      description: "Redis connection is unavailable"
  
  # Neo4j connection issues
  - alert: Neo4jConnectionFailure
    expr: |
      neo4j_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Neo4j is down"
      description: "Neo4j connection is unavailable"

